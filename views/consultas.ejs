<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Consultas médicas</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  </head>
  <body class="bg-light">
    <header class="bg-primary text-white mb-4">
      <nav class="navbar navbar-expand-lg navbar-dark container">
        <a class="navbar-brand fw-semibold" href="/dashboard">Centro Médico</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="/consultas">Consultas</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/administracion">Administración</a>
            </li>
          </ul>
        </div>
      </nav>
    </header>

    <main class="container">
      <div class="card shadow-sm mb-4">
        <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start gap-3">
          <div>
            <h1 class="h3 text-primary mb-1">Consultas médicas</h1>
            <p class="text-muted mb-0">
              Registra una nueva consulta clínica o revisa el historial de atención de los
              pacientes.
            </p>
          </div>
          <div class="d-flex flex-column flex-sm-row gap-2">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#consultaModal">
              Registrar consulta
            </button>
            <button id="historial-btn" class="btn btn-outline-primary">Ver historial</button>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-body">
          <h2 class="h5 mb-3">Historial de consultas</h2>
          <div class="table-responsive">
            <table class="table table-hover align-middle" id="consultas-table">
              <thead class="table-light">
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Médico</th>
                  <th scope="col">Paciente</th>
                  <th scope="col">Síntomas</th>
                  <th scope="col">Diagnóstico</th>
                  <th scope="col">Recomendaciones</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="6" class="text-center text-muted">Sin consultas registradas.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>

    <div class="modal fade" id="consultaModal" tabindex="-1" aria-labelledby="consultaModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="consultaModalLabel">Registrar nueva consulta</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <form id="consulta-form" class="needs-validation" novalidate>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="consulta-medico" class="form-label">Médico</label>
                  <select class="form-select" id="consulta-medico" required>
                    <option value="" selected disabled>Selecciona un médico</option>
                  </select>
                  <div class="form-text">Si no aparece, regístralo desde la sección de administración.</div>
                  <div class="invalid-feedback">Selecciona un médico válido.</div>
                </div>
                <div class="col-md-6">
                  <label for="consulta-paciente" class="form-label">ID del paciente</label>
                  <input
                    type="number"
                    min="1"
                    class="form-control"
                    id="consulta-paciente"
                    placeholder="Ej. 1"
                    required
                  />
                  <div class="form-text">Ingresa el identificador del paciente registrado en la base de datos.</div>
                  <div class="invalid-feedback">El ID del paciente es obligatorio.</div>
                </div>
                <div class="col-md-12">
                  <label for="consulta-sintomas" class="form-label">Síntomas</label>
                  <textarea class="form-control" id="consulta-sintomas" rows="2" maxlength="300"></textarea>
                </div>
                <div class="col-md-12">
                  <label for="consulta-diagnostico" class="form-label">Diagnóstico</label>
                  <textarea class="form-control" id="consulta-diagnostico" rows="2" maxlength="500"></textarea>
                </div>
                <div class="col-md-12">
                  <label for="consulta-recomendaciones" class="form-label">Recomendaciones</label>
                  <textarea class="form-control" id="consulta-recomendaciones" rows="2" maxlength="300"></textarea>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Guardar consulta</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script>
      const tablaConsultas = document.querySelector('#consultas-table tbody');
      const historialBtn = document.getElementById('historial-btn');
      const consultaForm = document.getElementById('consulta-form');
      const medicoSelect = document.getElementById('consulta-medico');

      async function loadMedicos() {
        try {
          const response = await fetch('/api/medicos');
          if (!response.ok) throw new Error('No se pudo cargar la lista de médicos');
          const medicos = await response.json();
          medicoSelect.innerHTML = '<option value="" disabled selected>Selecciona un médico</option>';
          medicos.forEach((medico) => {
            const option = document.createElement('option');
            const nombreCompleto = [
              medico.primer_nombre,
              medico.segundo_nombre,
              medico.apellido_paterno,
              medico.apellido_materno,
            ]
              .filter(Boolean)
              .join(' ');
            option.value = medico.id;
            option.textContent = `${nombreCompleto} (ID ${medico.id})`;
            medicoSelect.append(option);
          });
        } catch (error) {
          console.error(error);
          medicoSelect.innerHTML = '<option value="" disabled selected>No se pudieron cargar los médicos</option>';
        }
      }

      function renderConsultas(consultas) {
        if (!consultas.length) {
          tablaConsultas.innerHTML = `
            <tr>
              <td colspan="6" class="text-center text-muted">Sin consultas registradas.</td>
            </tr>
          `;
          return;
        }

        tablaConsultas.innerHTML = consultas
          .map((consulta) => {
            const medico = consulta.medico_nombre ? `${consulta.medico_nombre} (ID ${consulta.id_medico})` : `ID ${consulta.id_medico}`;
            const paciente = consulta.paciente_nombre ? `${consulta.paciente_nombre} (ID ${consulta.id_paciente})` : `ID ${consulta.id_paciente}`;
            return `
              <tr>
                <th scope="row">${consulta.id}</th>
                <td>${medico}</td>
                <td>${paciente}</td>
                <td>${consulta.sintomas ?? ''}</td>
                <td>${consulta.diagnostico ?? ''}</td>
                <td>${consulta.recomendaciones ?? ''}</td>
              </tr>
            `;
          })
          .join('');
      }

      async function loadConsultas() {
        try {
          historialBtn.disabled = true;
          const response = await fetch('/api/consultas');
          if (!response.ok) throw new Error('No se pudo obtener el historial de consultas');
          const consultas = await response.json();
          renderConsultas(consultas);
        } catch (error) {
          console.error(error);
          tablaConsultas.innerHTML = `
            <tr>
              <td colspan="6" class="text-center text-danger">${error.message}</td>
            </tr>
          `;
        } finally {
          historialBtn.disabled = false;
        }
      }

      consultaForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!consultaForm.checkValidity()) {
          consultaForm.classList.add('was-validated');
          return;
        }

        const consulta = {
          id_medico: medicoSelect.value,
          id_paciente: document.getElementById('consulta-paciente').value,
          sintomas: document.getElementById('consulta-sintomas').value.trim(),
          diagnostico: document.getElementById('consulta-diagnostico').value.trim(),
          recomendaciones: document.getElementById('consulta-recomendaciones').value.trim(),
        };

        try {
          const response = await fetch('/api/consultas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(consulta),
          });

          if (!response.ok) {
            const errorBody = await response.json().catch(() => ({}));
            throw new Error(errorBody.message || 'No se pudo registrar la consulta');
          }

          consultaForm.reset();
          consultaForm.classList.remove('was-validated');
          const modalInstance = bootstrap.Modal.getInstance(document.getElementById('consultaModal'));
          modalInstance.hide();
          await loadConsultas();
        } catch (error) {
          alert(error.message);
        }
      });

      historialBtn.addEventListener('click', loadConsultas);
      loadMedicos();
      loadConsultas();
    </script>
  </body>
</html>
